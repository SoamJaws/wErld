<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/travis/build/SoamJaws/wErld/.eunit/stop.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/travis/build/SoamJaws/wErld/.eunit/stop.erl by COVER 2016-07-05 at 15:36:59

****************************************************************************

        |  -module(stop).
        |  -include("public_transport.hrl").
        |  -behaviour(gen_server).
        |  
        |  %% Public API
        |  -export([ start_link/1
        |          , stop/1
        |          , state/1
        |          , ?PASSENGER_CHECK_IN/2
        |          , ?PASSENGER_CHECK_OUT/3
        |          , ?VEHICLE_CHECK_IN/3
        |          , ?VEHICLE_CHECK_OUT/3]).
        |  
        |  %% gen_server
        |  -export([ init/1
        |          , handle_call/3
        |          , handle_cast/2
        |          , handle_info/2
        |          , terminate/2
        |          , code_change/3]).
        |  
        |  
        |  %% Public API
        |  
        |  -spec start_link(atom()) -&gt; {ok, pid()} | ignore | {error, {already_started, pid()} | term()}.
        |  start_link(Id) -&gt;
    32..|    gen_server:start_link(?MODULE, Id, []).
        |  
        |  -spec stop(pid()) -&gt; ok.
        |  stop(Pid) -&gt;
<font color=red>     0..|    gen_server:call(Pid, stop).</font>
        |  
        |  -spec state(pid()) -&gt; stop_state().
        |  state(Pid) -&gt;
<font color=red>     0..|    gen_server:call(Pid, state).</font>
        |  
        |  -spec ?PASSENGER_CHECK_IN(pid(), pid()) -&gt; ok | {nok, nonempty_string()}.
        |  ?PASSENGER_CHECK_IN(Pid, Passenger) -&gt;
<font color=red>     0..|    gen_server:call(Pid, {?PASSENGER_CHECK_IN, Passenger}).</font>
        |  
        |  -spec ?PASSENGER_CHECK_OUT(pid(), pid(), boolean())-&gt; ok.
        |  ?PASSENGER_CHECK_OUT(Pid, Passenger, BlockCaller) -&gt;
<font color=red>     0..|    gen_server_utils:cast(Pid, {?PASSENGER_CHECK_OUT, Passenger}, BlockCaller).</font>
        |  
        |  -spec ?VEHICLE_CHECK_IN(pid(), pid(), boolean()) -&gt; ok.
        |  ?VEHICLE_CHECK_IN(Pid, Vehicle, BlockCaller) -&gt;
<font color=red>     0..|    gen_server_utils:cast(Pid, {?VEHICLE_CHECK_IN, Vehicle}, BlockCaller).</font>
        |  
        |  -spec ?VEHICLE_CHECK_OUT(pid(), pid(), boolean()) -&gt; ok.
        |  ?VEHICLE_CHECK_OUT(Pid, Vehicle, BlockCaller) -&gt;
<font color=red>     0..|    gen_server_utils:cast(Pid, {?VEHICLE_CHECK_OUT, Vehicle}, BlockCaller).</font>
        |  
        |  
        |  %% gen_server
        |  
        |  -spec init(atom()) -&gt; {ok, stop_state()}.
        |  init(Id) -&gt;
    32..|    {ok, #stop_state{id=Id}}.
        |  
        |  
        |  -spec handle_call({?PASSENGER_CHECK_IN, pid()}, {pid(), any()}, stop_state()) -&gt; {reply, ok | {nok, string()}, stop_state()}
        |        ;          (stop,                         {pid(), any()}, stop_state()) -&gt; {stop, normal, stopped, stop_state()}
        |        ;          (state,                        {pid(), any()}, stop_state()) -&gt; {reply, stop_state(), stop_state()}.
        |  handle_call({?PASSENGER_CHECK_IN, Passenger}, _From, State) -&gt;
<font color=red>     0..|    Passengers = State#stop_state.passengers,</font>
<font color=red>     0..|    AlreadyCheckedIn = lists:member(Passenger, Passengers),</font>
<font color=red>     0..|    if</font>
        |      AlreadyCheckedIn -&gt;
<font color=red>     0..|        {reply, {nok, "Already checked in"}, State};</font>
        |      true -&gt;
<font color=red>     0..|        CurrentVehicle = State#stop_state.currentVehicle,</font>
<font color=red>     0..|        case CurrentVehicle of</font>
        |          none -&gt;
<font color=red>     0..|            ok;</font>
        |          Vehicle -&gt;
<font color=red>     0..|            WillBoard = citizen:vehicle_checked_in(Passenger, Vehicle),</font>
<font color=red>     0..|            if</font>
        |              WillBoard -&gt;
<font color=red>     0..|                vehicle:?INCREMENT_BOARDING_PASSENGER(Vehicle, false);</font>
        |              true -&gt;
<font color=red>     0..|                ok</font>
        |            end
        |        end,
<font color=red>     0..|        {reply, ok, State#stop_state{passengers=Passengers++[Passenger]}}</font>
        |    end;
        |  
        |  handle_call(stop, _From, State) -&gt;
<font color=red>     0..|    {stop, normal, stopped, State};</font>
        |  
        |  handle_call(state, _From, State) -&gt;
<font color=red>     0..|    {reply, State, State}.</font>
        |  
        |  
        |  -spec handle_cast({?PASSENGER_CHECK_OUT, pid(), boolean(), pid()}, stop_state()) -&gt; {noreply, stop_state()}
        |        ;          ({?VEHICLE_CHECK_IN, pid(), boolean(), pid()}, stop_state()) -&gt; {noreply, stop_state()}
        |        ;          ({?VEHICLE_CHECK_OUT, pid(), boolean(), pid()}, stop_state()) -&gt; {noreply, stop_state()}.
        |  handle_cast({?PASSENGER_CHECK_OUT, Passenger, NotifyCaller, Caller}, State) -&gt;
<font color=red>     0..|    Passengers = lists:delete(Passenger, State#stop_state.passengers),</font>
<font color=red>     0..|    gen_server_utils:notify_caller(NotifyCaller, Caller),</font>
<font color=red>     0..|    {noreply, State#stop_state{passengers=Passengers}};</font>
        |  
        |  handle_cast({?VEHICLE_CHECK_IN, Vehicle, NotifyCaller, Caller}, State) -&gt;
<font color=red>     0..|    NewState = case State#stop_state.currentVehicle of</font>
        |                 none -&gt;
<font color=red>     0..|                   BoardingPassengers = notify_vehicle_checked_in(State#stop_state.passengers, Vehicle),</font>
<font color=red>     0..|                   vehicle:?CHECKIN_OK(Vehicle, self(), BoardingPassengers, false),</font>
<font color=red>     0..|                   State#stop_state{currentVehicle=Vehicle};</font>
        |                 _    -&gt;
<font color=red>     0..|                   VehicleQueue = State#stop_state.vehicleQueue,</font>
<font color=red>     0..|                   State#stop_state{vehicleQueue=VehicleQueue++[Vehicle]}</font>
        |    end,
<font color=red>     0..|    gen_server_utils:notify_caller(NotifyCaller, Caller),</font>
<font color=red>     0..|    {noreply, NewState};</font>
        |  
        |  handle_cast({?VEHICLE_CHECK_OUT, Vehicle, NotifyCaller, Caller}, State) -&gt;
<font color=red>     0..|    NewState = if</font>
        |                 State#stop_state.currentVehicle == Vehicle -&gt;
<font color=red>     0..|                   case State#stop_state.vehicleQueue of</font>
        |                     [NextVehicle|VehicleQueue] -&gt;
<font color=red>     0..|                       BoardingPassengers = notify_vehicle_checked_in(State#stop_state.passengers, NextVehicle),</font>
<font color=red>     0..|                       vehicle:?CHECKIN_OK(NextVehicle, self(), BoardingPassengers, false),</font>
<font color=red>     0..|                       State#stop_state{currentVehicle=NextVehicle, vehicleQueue=VehicleQueue};</font>
        |                     [] -&gt;
<font color=red>     0..|                       State#stop_state{currentVehicle=none}</font>
        |                   end;
        |                 true -&gt;
<font color=red>     0..|                   State</font>
        |    end,
<font color=red>     0..|    gen_server_utils:notify_caller(NotifyCaller, Caller),</font>
<font color=red>     0..|    {noreply, NewState}.</font>
        |  
        |  
        |  -spec handle_info(timeout | any(), stop_state()) -&gt; {noreply, stop_state()}.
        |  handle_info(_Info, State) -&gt;
<font color=red>     0..|    {noreply, State}.</font>
        |  
        |  
        |  -spec terminate(normal | shutdown | {shutdown, any()} | any(), stop_state()) -&gt; ok.
        |  terminate(_Reason, _State) -&gt;
<font color=red>     0..|    ok.</font>
        |  
        |  
        |  -spec code_change(term() | {down, term()}, stop_state(), term()) -&gt; {ok, stop_state()}.
        |  code_change(_OldVsn, State, _Extra) -&gt;
<font color=red>     0..|    {ok, State}.</font>
        |  
        |  
        |  %% Backend
        |  
        |  -spec notify_vehicle_checked_in([pid()], pid()) -&gt; non_neg_integer().
        |  notify_vehicle_checked_in(Passengers, Vehicle) -&gt;
<font color=red>     0..|    notify_vehicle_checked_in(Passengers, Vehicle, 0).</font>
        |  
        |  -spec notify_vehicle_checked_in([pid()], pid(), non_neg_integer()) -&gt; non_neg_integer().
<font color=red>     0..|  notify_vehicle_checked_in([], _Vehicle, BoardingPassengers) -&gt; BoardingPassengers;</font>
        |  notify_vehicle_checked_in([Passenger|Passengers], Vehicle, BoardingPassengers) -&gt;
<font color=red>     0..|    WillBoard = citizen:vehicle_checked_in(Passenger, Vehicle),</font>
<font color=red>     0..|    if</font>
        |      WillBoard -&gt;
<font color=red>     0..|        notify_vehicle_checked_in(Passengers, Vehicle, BoardingPassengers + 1);</font>
        |      true -&gt;
<font color=red>     0..|        notify_vehicle_checked_in(Passengers, Vehicle, BoardingPassengers)</font>
        |    end.
</pre>
</body>
</html>
