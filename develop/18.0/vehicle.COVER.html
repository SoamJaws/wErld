<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/travis/build/SoamJaws/wErld/.eunit/vehicle.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/travis/build/SoamJaws/wErld/.eunit/vehicle.erl by COVER 2016-06-28 at 19:29:25

****************************************************************************

        |  -module(vehicle).
        |  -include("infrastructure.hrl").
        |  -include("time.hrl").
        |  -behaviour(gen_server).
        |  
        |  %% Public API
        |  -export([ start_link/4
        |          , stop/1
        |          , state/1
        |          , ?PASSENGER_BOARD/2
        |          , ?NEW_TIME/3
        |          , ?INCREMENT_BOARDING_PASSENGER/2
        |          , ?CHECKIN_OK/4]).
        |  
        |  %% gen_server
        |  -export([ init/1
        |          , handle_call/3
        |          , handle_cast/2
        |          , handle_info/2
        |          , terminate/2
        |          , code_change/3]).
        |  
        |  
        |  %% Public API
        |  
        |  start_link(Capacity, Line, Target, Type) -&gt;
     7..|    gen_server:start_link(?MODULE, #vehicle_state{capacity=Capacity, line=Line, target=Target, type=Type}, []).
        |  
        |  stop(Pid) -&gt;
     7..|    gen_server:call(Pid, stop).
        |  
        |  state(Pid) -&gt;
<font color=red>     0..|    gen_server:call(Pid, state).</font>
        |  
        |  ?PASSENGER_BOARD(Pid, Passenger) -&gt;
    19..|    gen_server:call(Pid, {?PASSENGER_BOARD, Passenger}).
        |  
        |  ?NEW_TIME(Pid, Time, BlockCaller) -&gt;
     3..|    gen_server:cast(Pid, {?NEW_TIME, Time, BlockCaller, self()}),
     3..|    gen_server_utils:block_caller(BlockCaller).
        |  
        |  ?INCREMENT_BOARDING_PASSENGER(Pid, BlockCaller) -&gt;
     2..|    gen_server:cast(Pid, {?INCREMENT_BOARDING_PASSENGER, BlockCaller, self()}),
     2..|    gen_server_utils:block_caller(BlockCaller).
        |  
        |  ?CHECKIN_OK(Pid, Stop, BoardingPassengers, BlockCaller) -&gt;
    13..|    gen_server:cast(Pid, {?CHECKIN_OK, Stop, BoardingPassengers, BlockCaller, self()}),
    13..|    gen_server_utils:block_caller(BlockCaller).
        |  
        |  
        |  %% gen_server
        |  
        |  init(State) -&gt;
     7..|    gen_server:cast({global, blackboard}, {subscribe, time}),
     7..|    Line = State#vehicle_state.line,
     7..|    LineNumber = line:?GET_NUMBER(Line),
     7..|    Stop = line:?GET_OTHER_END(Line, State#vehicle_state.target),
     7..|    stop:?VEHICLE_CHECK_IN(Stop, self(), false),
     7..|    {ok, State#vehicle_state{line={LineNumber, Line}}}.
        |  
        |  
        |  handle_call({?PASSENGER_BOARD, Passenger}, _From, State) -&gt;
    19..|    Passengers = State#vehicle_state.passengers,
    19..|    Capacity = State#vehicle_state.capacity,
    19..|    NoPassengers = length(Passengers),
    19..|    BoardingPassengers = State#vehicle_state.boardingPassengers,
    19..|    if
        |      NoPassengers &lt; Capacity -&gt;
    18..|        UpdatedState = State#vehicle_state{passengers=Passengers++[Passenger], boardingPassengers=BoardingPassengers-1},
    18..|        NewState = if (Capacity - NoPassengers == 1) or (BoardingPassengers == 1) -&gt;
     6..|                     boarding_complete(UpdatedState);
        |                   true -&gt;
    12..|                     UpdatedState
        |                   end,
    18..|        {reply, ok, NewState};
        |      true -&gt;
     1..|        {reply, nok, State}
        |    end;
        |  
        |  handle_call(stop, _From, State) -&gt;
     7..|    {stop, normal, stopped, State};
        |  
        |  handle_call(state, _From, State) -&gt;
<font color=red>     0..|    {reply, {ok, State}, State}.</font>
        |  
        |  
        |  handle_cast({?NEW_TIME, Time, NotifyCaller, Caller}, State) -&gt;
     3..|    NewState = case State#vehicle_state.action of
        |                 {driving, Stop, Duration} -&gt;
     3..|                   if
        |                     Time - State#vehicle_state.lastDeparture &gt;= Duration -&gt;
     2..|                       UpdatedState = if
        |                                        Stop == State#vehicle_state.target -&gt;
     1..|                                          {_, Line} = State#vehicle_state.line,
     1..|                                          Target = line:?GET_OTHER_END(Line, State#vehicle_state.target),
     1..|                                          State#vehicle_state{target=Target};
        |                                      true -&gt;
     1..|                                        State
        |                                      end,
     2..|                       StayingPassengers = notify_passengers_checkin(State#vehicle_state.passengers),
     2..|                       stop:?VEHICLE_CHECK_IN(Stop, self(), false),
     2..|                       UpdatedState#vehicle_state{passengers=StayingPassengers};
        |                     true -&gt;
     1..|                       State
        |                   end;
        |                 _ -&gt;
<font color=red>     0..|                   State</font>
        |               end,
     3..|    gen_server_utils:notify_caller(NotifyCaller, Caller),
     3..|    {noreply, NewState};
        |  
        |  handle_cast({?INCREMENT_BOARDING_PASSENGER, NotifyCaller, Caller}, State) -&gt;
     1..|    BoardingPassengers = State#vehicle_state.boardingPassengers,
     1..|    gen_server_utils:notify_caller(NotifyCaller, Caller),
     1..|    {noreply, State#vehicle_state{boardingPassengers=BoardingPassengers+1}};
        |  
        |  handle_cast({?CHECKIN_OK, Stop, BoardingPassengers, NotifyCaller, Caller}, State) -&gt;
     7..|    NewState = if
        |                 BoardingPassengers == 0 -&gt;
     1..|                   boarding_complete(State#vehicle_state{action={boarding, Stop}});
        |                 true -&gt;
     6..|                   State#vehicle_state{action={boarding, Stop}, boardingPassengers=BoardingPassengers}
        |               end,
     7..|    gen_server_utils:notify_caller(NotifyCaller, Caller),
     7..|    {noreply, NewState}.
        |  
        |  
        |  handle_info(_Info, State) -&gt;
<font color=red>     0..|    {noreply, State}.</font>
        |  
        |  
        |  terminate(_Reason, _State) -&gt;
     7..|    ok.
        |  
        |  
        |  code_change(_OldVsn, State, _Extra) -&gt;
<font color=red>     0..|    {ok, State}.</font>
        |  
        |  
        |  %% Backend
        |  
        |  boarding_complete(State) -&gt;
     7..|    {_, Line} = State#vehicle_state.line,
     7..|    {boarding, Stop} = State#vehicle_state.action,
     7..|    {NextStop, Dur} = line:?GET_NEXT_STOP(Line, State#vehicle_state.target, Stop),
     7..|    TimePid = gen_server:call({global, blackboard}, {request, timePid}),
     7..|    Time = gen_server:call(TimePid, {request, currentTime}),
     7..|    stop:?VEHICLE_CHECK_OUT(Stop, self(), false),
     7..|    State#vehicle_state{action={driving, NextStop, Dur}, lastDeparture=Time, boardingPassengers=0}.
        |  
     2..|  notify_passengers_checkin([]) -&gt; [];
        |  notify_passengers_checkin([Passenger|Passengers]) -&gt;
     6..|    Reply = citizen:vehicle_checked_in(Passenger, self()),
     6..|    case Reply of
        |      leave -&gt;
     2..|        notify_passengers_checkin(Passengers);
        |      stay -&gt;
     4..|        [Passenger|notify_passengers_checkin(Passengers)]
        |    end.
</pre>
</body>
</html>
