<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/travis/build/SoamJaws/wErld/test/logs/ct_run.test@testing-worker-linux-docker-9725a96f-3462-linux-6.2016-07-29_07.26.33/line.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/travis/build/SoamJaws/wErld/ebin/../src/client/public_transport/line.erl by COVER 2016-07-29 at 07:26:47

****************************************************************************

        |  -module(line).
        |  -include("public_transport.hrl").
        |  -include("logger.hrl").
        |  -behaviour(gen_server).
        |  
        |  %% Public API
        |  -export([ ?GET_NEXT_STOP/3
        |          , ?GET_NEIGHBORS/2
        |          , ?GET_OTHER_END/2
        |          , ?CONTAINS_STOP/2
        |          , ?GET_DURATION/3
        |          , ?IS_END_STOP/2
        |          , ?GET_INTERSECTION/2
        |          , ?GET_NUMBER/1
        |          , ?GET_TARGET/3]).
        |  
        |  %% gen_server
        |  -export([ start_link/3
        |          , init/1
        |          , handle_call/3
        |          , handle_cast/2
        |          , handle_info/2
        |          , terminate/2
        |          , code_change/3]).
        |  
        |  
        |  %% Public API
        |  
        |  -spec ?GET_NEXT_STOP(line(), stop(), stop()) -&gt; {stop(), pos_integer()} | none.
        |  ?GET_NEXT_STOP(?RECIPENT, Target, Stop) -&gt;
    14..|    ?LOG_SEND(io_lib:format("GET_NEXT_STOP Line=~p TargetStop=~p CurrentStop=~p", [?RECIPENT, Target, Stop])),
    14..|    Reply = gen_server:call(Pid, {?GET_NEXT_STOP, Target, Stop}),
    14..|    ?LOG_RECEIVE(io_lib:format("REPLY GET_NEXT_STOP ~p", [Reply])),
    14..|    Reply.
        |  
        |  -spec ?GET_NEIGHBORS(line(), stop()) -&gt; [{stop(), pos_integer(), stop(), line()}].
        |  ?GET_NEIGHBORS(?RECIPENT, Stop) -&gt;
  3063..|    ?LOG_SEND(io_lib:format("GET_NEIGHBORS Line=~p Stop=~p", [?RECIPENT, Stop])),
  3063..|    Reply = gen_server:call(Pid, {?GET_NEIGHBORS, Stop}),
  2712..|    ?LOG_RECEIVE(io_lib:format("REPLY GET_NEIGHBORS ~p", [Reply])),
  2712..|    Reply.
        |  
        |  -spec ?GET_OTHER_END(line(), stop()) -&gt; stop().
        |  ?GET_OTHER_END(?RECIPENT, Stop) -&gt;
    11..|    ?LOG_SEND(io_lib:format("GET_OTHER_END Line=~p Stop=~p", [?RECIPENT, Stop])),
    11..|    Reply = gen_server:call(Pid, {?GET_OTHER_END, Stop}),
    11..|    ?LOG_RECEIVE(io_lib:format("REPLY GET_OTHER_END ~p", [Reply])),
    11..|    Reply.
        |  
        |  -spec ?CONTAINS_STOP(line(), stop()) -&gt; boolean().
        |  ?CONTAINS_STOP(?RECIPENT, Stop) -&gt;
 37547..|    ?LOG_SEND(io_lib:format("CONTAINS_STOP Line=~p Stop=~p", [?RECIPENT, Stop])),
 37547..|    Reply = gen_server:call(Pid, {?CONTAINS_STOP, Stop}),
 35853..|    ?LOG_RECEIVE(io_lib:format("REPLY CONTAINS_STOP ~p", [Reply])),
 35853..|    Reply.
        |  
        |  -spec ?GET_DURATION(line(), stop(), stop()) -&gt; pos_integer().
        |  ?GET_DURATION(?RECIPENT, FromStop, ToStop) -&gt;
   126..|    ?LOG_SEND(io_lib:format("GET_DURATION Line=~p FromStop=~p ToStop=~p", [?RECIPENT, FromStop, ToStop])),
   126..|    Reply = gen_server:call(Pid, {?GET_DURATION, FromStop, ToStop}),
   125..|    ?LOG_RECEIVE(io_lib:format("REPLY GET_DURATION ~p", [Reply])),
   125..|    Reply.
        |  
        |  -spec ?IS_END_STOP(line(), stop()) -&gt; boolean().
        |  ?IS_END_STOP(?RECIPENT, Stop) -&gt;
     3..|    ?LOG_SEND(io_lib:format("IS_END_STOP Line=~p Stop=~p", [?RECIPENT, Stop])),
     3..|    Reply = gen_server:call(Pid, {?IS_END_STOP, Stop}),
     3..|    ?LOG_RECEIVE(io_lib:format("REPLY IS_END_STOP ~p", [Reply])),
     3..|    Reply.
        |  
        |  -spec ?GET_INTERSECTION(line(), line()) -&gt; stop() | none.
        |  ?GET_INTERSECTION(?RECIPENT, OtherLine) -&gt;
  3703..|    ?LOG_SEND(io_lib:format("GET_INTERSECTION Line=~p OtherLine=~p", [?RECIPENT, OtherLine])),
  3703..|    Reply = gen_server:call(Pid, {?GET_INTERSECTION, OtherLine}),
  3421..|    ?LOG_RECEIVE(io_lib:format("REPLY GET_INTERSECTION ~p", [Reply])),
  3421..|    Reply.
        |  
        |  -spec ?GET_NUMBER(line()) -&gt; pos_integer().
        |  ?GET_NUMBER(?RECIPENT) -&gt;
     9..|    ?LOG_SEND(io_lib:format("GET_NUMBER Line=~p", [?RECIPENT])),
     9..|    Reply = gen_server:call(Pid, ?GET_NUMBER),
     9..|    ?LOG_RECEIVE(io_lib:format("REPLY GET_NUMBER ~p", [Reply])),
     9..|    Reply.
        |  
        |  -spec ?GET_TARGET(line(), stop(), stop()) -&gt; stop().
        |  ?GET_TARGET(?RECIPENT, FromStop, ToStop) -&gt;
    56..|    ?LOG_SEND(io_lib:format("GET_TARGET Line=~p FromStop=~p ToStop=~p", [?RECIPENT, FromStop, ToStop])),
    56..|    Reply = gen_server:call(Pid, {?GET_TARGET, FromStop, ToStop}),
    56..|    ?LOG_RECEIVE(io_lib:format("REPLY GET_TARGET ~p", [Reply])),
    56..|    Reply.
        |  
        |  %% gen_server
        |  
        |  -spec start_link(pos_integer(), [pid() | pos_integer()], vehicle_type()) -&gt; {ok, pid()} | ignore | {error, {already_started, pid()} | term()}.
        |  start_link(Number, Stops, Type) -&gt;
    16..|    gen_server:start_link(?MODULE, {Number, Stops, Type}, []).
        |  
        |  
        |  -spec init({pos_integer(), [pid() | pos_integer()], vehicle_type()}) -&gt; {ok, line_state()}.
        |  init({Number, Stops, Type}) -&gt;
    16..|    Id = list_to_atom(atom_to_list(Type) ++ "_" ++ integer_to_list(Number)),
    16..|    put(id, Id),
    16..|    put(module, ?MODULE_STRING),
    16..|    ?LOG_INFO("Line started"),
    16..|    {ok, #line_state{id=Id, number=Number, stops=Stops, type=Type}}.
        |  
        |  
        |  -spec handle_call({?GET_NEXT_STOP, stop(), stop()}, {pid(), any()}, line_state()) -&gt; {reply, {stop(), pos_integer()} | none, line_state()}
        |        ;          ({?GET_NEIGHBORS, stop()},         {pid(), any()}, line_state()) -&gt; {reply, [{stop(), pos_integer(), stop(), line()}], line_state()}
        |        ;          ({?GET_OTHER_END, stop()},         {pid(), any()}, line_state()) -&gt; {reply, stop(), line_state()}
        |        ;          ({?CONTAINS_STOP, stop()},         {pid(), any()}, line_state()) -&gt; {reply, boolean(), line_state()}
        |        ;          ({?GET_DURATION, stop(), stop()},  {pid(), any()}, line_state()) -&gt; {reply, pos_integer(), line_state()}
        |        ;          ({?IS_END_STOP, stop()},           {pid(), any()}, line_state()) -&gt; {reply, boolean(), line_state()}
        |        ;          ({?GET_INTERSECTION, line()},      {pid(), any()}, line_state()) -&gt; {reply, stop() | none, line_state()}
        |        ;          (?GET_NUMBER,                      {pid(), any()}, line_state()) -&gt; {reply, pos_integer(), line_state()}
        |        ;          ({?GET_TARGET, stop(), stop()},    {pid(), any()}, line_state()) -&gt; {reply, stop(), line_state()}.
        |  handle_call({?GET_NEXT_STOP, Target, Stop}, _From, State) -&gt;
     6..|    ?LOG_RECEIVE(io_lib:format("GET_NEXT_STOP Target=~p Stop=~p", [Target, Stop])),
     6..|    [EndStop|_] = State#line_state.stops,
     6..|    Reply = case EndStop of
     3..|              Target -&gt; get_next_stop_helper(Stop, pre, State#line_state.stops);
     3..|              _      -&gt; get_next_stop_helper(Stop, post, State#line_state.stops)
        |            end,
     6..|    {reply, Reply, State};
        |  
        |  handle_call({?GET_NEIGHBORS, Stop}, _From, State) -&gt;
  2712..|    ?LOG_RECEIVE(io_lib:format("GET_NEIGHBORS Stop=~p", [Stop])),
  2712..|    Id = State#line_state.id,
  2712..|    {BeforeStop, [Stop|AfterStop]} = lists:splitwith(fun(X) -&gt; X /= Stop end, State#line_state.stops),
  2712..|    Pid = self(),
  2712..|    N1 = case BeforeStop of
        |           [FirstTarget|_] -&gt;
  2320..|             FirstNeighbor = lists:last(lists:droplast(BeforeStop)),
  2320..|             [{FirstNeighbor, lists:last(BeforeStop), FirstTarget, ?RECIPENT}];
        |           [] -&gt;
   392..|             []
        |         end,
  2712..|    N2 = case AfterStop of
        |           [SecondDur|[SecondNeighbor|_]] -&gt;
  2474..|             [{SecondNeighbor, SecondDur, lists:last(AfterStop), ?RECIPENT}];
        |           [] -&gt;
   238..|             []
        |         end,
  2712..|    Reply = N1 ++ N2,
  2712..|    {reply, Reply, State};
        |  
        |  handle_call({?GET_OTHER_END, Stop}, _From, State) -&gt;
     2..|    ?LOG_RECEIVE(io_lib:format("GET_OTHER_END Stop=~p", [Stop])),
     2..|    [H|T] = State#line_state.stops,
     2..|    Reply = case H of
     1..|              Stop -&gt; lists:last(T);
     1..|              _    -&gt; H
        |            end,
     2..|    {reply, Reply, State};
        |  
        |  handle_call({?CONTAINS_STOP, Stop}, _From, State) -&gt;
 35854..|    ?LOG_RECEIVE(io_lib:format("CONTAINS_STOP Stop=~p", [Stop])),
 35854..|    Reply = lists:member(Stop, State#line_state.stops),
 35854..|    {reply, Reply, State};
        |  
        |  handle_call({?GET_DURATION, FromStop, ToStop}, _From, State) -&gt;
   125..|    ?LOG_RECEIVE(io_lib:format("GET_DURATION FromStop=~p ToStop=~p", [FromStop, ToStop])),
   125..|    Reply = get_duration_helper(FromStop, ToStop, State#line_state.stops),
   125..|    {reply, Reply, State};
        |  
        |  handle_call({?IS_END_STOP, Stop}, _From, State) -&gt;
     3..|    ?LOG_RECEIVE(io_lib:format("IS_END_STOP Stop=~p", [Stop])),
     3..|    Reply = lists:prefix([Stop], State#line_state.stops) or lists:suffix([Stop], State#line_state.stops),
     3..|    {reply, Reply, State};
        |  
        |  handle_call({?GET_INTERSECTION, OtherLine}, _From, State) -&gt;
  3422..|    ?LOG_RECEIVE(io_lib:format("GET_INTERSECTION OtherLine=~p", [OtherLine])),
  3422..|    Reply = get_intersection_helper(OtherLine, lists:filter(fun(Stop) -&gt;
 35780..|                                                              case Stop of
        |                                                                ?ADDRESS(stop) -&gt;
 19601..|                                                                  true;
        |                                                                _ -&gt;
 16179..|                                                                  false
        |                                                              end
        |                                                            end, State#line_state.stops)),
  3421..|    {reply, Reply, State};
        |  
        |  handle_call(?GET_NUMBER, _From, State) -&gt;
     1..|    ?LOG_RECEIVE(io_lib:format("GET_NUMBER", [])),
     1..|    Reply = State#line_state.number,
     1..|    {reply, Reply, State};
        |  
        |  handle_call({?GET_TARGET, FromStop, ToStop}, _From, State) -&gt;
    56..|    ?LOG_RECEIVE(io_lib:format("GET_TARGET FromStop=~p ToStop=~p", [FromStop, ToStop])),
    56..|    Reply = get_target_helper(FromStop, ToStop, State#line_state.stops),
    56..|    {reply, Reply, State}.
        |  
        |  
        |  -spec handle_cast(any(), line_state()) -&gt; {noreply, line_state()}.
        |  handle_cast(_Cast, State) -&gt;
<font color=red>     0..|    {noreply, State}.</font>
        |  
        |  
        |  -spec handle_info(timeout | any(), line_state()) -&gt; {noreply, line_state()}.
        |  handle_info(_Info, State) -&gt;
<font color=red>     0..|    {noreply, State}.</font>
        |  
        |  
        |  -spec terminate(normal | shutdown | {shutdown, any()} | any(), line_state()) -&gt; ok.
        |  terminate(_Reason, _State) -&gt;
<font color=red>     0..|    ok.</font>
        |  
        |  
        |  -spec code_change(term() | {down, term()}, line_state(), term()) -&gt; {ok, line_state()}.
        |  code_change(_OldVsn, State, _Extra) -&gt;
<font color=red>     0..|    {ok, State}.</font>
        |  
        |  
        |  %% Backend
        |  
        |  -spec get_next_stop_helper(stop(), pre | post, [stop() | pos_integer()]) -&gt; {stop(), pos_integer()} | none.
     2..|  get_next_stop_helper(_Stop, _, [_|[]]) -&gt; none; %%TODO ERROR log, since vehicles should always turn around when they arrive at their end stations. There should always be a next stop.
        |  get_next_stop_helper(Stop, pre, [NextStop|[Dur|[Stop|_]]]) -&gt;
     2..|    {NextStop, Dur};
        |  get_next_stop_helper(Stop, post, [Stop|[Dur|[NextStop|_]]]) -&gt;
     2..|    {NextStop, Dur};
        |  get_next_stop_helper(Stop, Alignment, [_S|[_Dur|Stops]]) -&gt;
     6..|    ?LOG_INFO(io_lib:format("get_next_stop_helper Stop=~p Alignment=~p Stops=~p", [Stop, Alignment, Stops])),
     6..|    get_next_stop_helper(Stop, Alignment, Stops).
        |  
        |  -spec get_duration_helper(stop(), stop(), [stop() | pos_integer()]) -&gt; pos_integer().
        |  get_duration_helper(FromStop, ToStop, Stops) -&gt;
   125..|    get_duration_helper(FromStop, ToStop, false, Stops).
        |  
        |  -spec get_duration_helper(stop(), stop(), boolean(), [stop() | pos_integer()]) -&gt; non_neg_integer().
   115..|  get_duration_helper(_FromStop, ToStop, true, [ToStop|_Stops]) -&gt; 0;
    10..|  get_duration_helper(FromStop, _ToStop, true, [FromStop|_Stops]) -&gt; 0;
        |  get_duration_helper(FromStop, ToStop, _OnPath, [FromStop|[Dur|Stops]]) -&gt;
   115..|    ?LOG_INFO(io_lib:format("get_duration_helper Stops head is FromStop, FromStop=~p ToStop=~p Dur=~p Stops=~p", [FromStop, ToStop, Dur, Stops])),
   115..|    Dur + get_duration_helper(FromStop, ToStop, true, Stops);
        |  get_duration_helper(FromStop, ToStop, _OnPath, [ToStop|[Dur|Stops]]) -&gt;
    10..|    ?LOG_INFO(io_lib:format("get_duration_helper Stops head is ToStop, FromStop=~p ToStop=~p Dur=~p Stops=~p", [FromStop, ToStop, Dur, Stops])),
    10..|    Dur + get_duration_helper(FromStop, ToStop, true, Stops);
        |  get_duration_helper(FromStop, ToStop, OnPath, [_S|[Dur|Stops]]) -&gt;
    93..|    ?LOG_INFO(io_lib:format("get_duration_helper Stops head does not match FromStop or ToStop, FromStop=~p ToStop=~p OnPath~p Dur=~p Stops=~p", [FromStop, ToStop, OnPath, Dur, Stops])),
    93..|    case OnPath of
        |      true -&gt;
    20..|        Dur + get_duration_helper(FromStop, ToStop, true, Stops);
        |      false -&gt;
    73..|        get_duration_helper(FromStop, ToStop, false, Stops)
        |    end.
        |  
        |  -spec get_intersection_helper(line(), [stop()]) -&gt; stop() | none.
  3328..|  get_intersection_helper(OtherLine, []) -&gt; none;
        |  get_intersection_helper(OtherLine, [Stop|Rest]) -&gt;
 19503..|    ?LOG_INFO(io_lib:format("get_intersection_helper OtherLine=~p Stop=~p Rest=~p", [OtherLine, Stop, Rest])),
 19503..|    ContainsStop = ?CONTAINS_STOP(OtherLine, Stop),
 19502..|    case ContainsStop of
        |      true -&gt;
    93..|        Stop;
        |      false -&gt;
 19409..|        get_intersection_helper(OtherLine, Rest)
        |    end.
        |  
        |  -spec get_target_helper(stop(), stop(), [stop() | pos_integer()]) -&gt; stop().
        |  get_target_helper(FromStop, ToStop, [FirstEnd|[_|Stops]]) -&gt;
    56..|    get_target_helper(FromStop, ToStop, FirstEnd, lists:filter(fun(Stop) -&gt; not is_integer(Stop) end, Stops)).
        |  
        |  -spec get_target_helper(stop(), stop(), stop(), [stop() | pos_integer()]) -&gt; stop().
        |  get_target_helper(FromStop, _ToStop, FromStop, Stops) -&gt;
     1..|    lists:last(Stops);
        |  get_target_helper(FromStop, ToStop, FirstEnd, [Stop|Stops]) -&gt;
    57..|    ?LOG_INFO(io_lib:format("get_target_helper FromStop=~p ToStop=~p FirstEnd=~p Stop=~p Stops=~p", [FromStop, ToStop, FirstEnd, Stop, Stops])),
    57..|    case Stop of
        |      FromStop -&gt;
    53..|        lists:last(Stops);
        |      ToStop -&gt;
     2..|        FirstEnd;
        |      Stop -&gt;
     2..|        get_target_helper(FromStop, ToStop, FirstEnd, Stops)
        |    end.
</pre>
</body>
</html>
