<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/travis/build/SoamJaws/wErld/test/logs/ct_run.test@testing-worker-linux-docker-1438938d-3445-linux-6.2016-08-16_20.19.35/weather_controller.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/travis/build/SoamJaws/wErld/ebin/../src/client/weather_controller.erl by COVER 2016-08-16 at 20:19:47

****************************************************************************

        |  -module(weather_controller).
        |  -include("weather.hrl").
        |  -include("time.hrl").
        |  -behaviour(gen_server).
        |  -behaviour(time_subscriber).
        |  
        |  %% Public API
        |  -export([ ?GET_TYPE/0
        |          , ?GET_TEMP/0]).
        |  
        |  %% Time subscriber
        |  -export([ ?NEW_TIME/2
        |          , ?NEW_TIME/3]).
        |  
        |  %% gen_server
        |  -export([ start_link/3
        |          , init/1
        |          , handle_call/3
        |          , handle_cast/2
        |          , handle_info/2
        |          , terminate/2
        |          , code_change/3]).
        |  
        |  %% Public API
        |  
        |  -spec ?GET_TYPE() -&gt; weather_type().
        |  ?GET_TYPE() -&gt;
 70080..|    ets_utils:set_lookup(?MODULE, type).
        |  
        |  -spec ?GET_TEMP() -&gt; integer().
        |  ?GET_TEMP() -&gt;
 35040..|    ets_utils:set_lookup(?MODULE, temp).
        |  
        |  
        |  %% Time subscriber
        |  
        |  -spec ?NEW_TIME(gen_address(), time()) -&gt; ok.
        |  ?NEW_TIME(Address, Time) -&gt;
<font color=red>     0..|    ?NEW_TIME(Address, Time, false).</font>
        |  
        |  -spec ?NEW_TIME(gen_address(), time(), boolean()) -&gt; ok.
        |  ?NEW_TIME(Address, Time, BlockCaller) -&gt;
 35040..|    gen_server_utils:cast(Address, {?NEW_TIME, Time}, BlockCaller).
        |  
        |  
        |  %% gen_server
        |  
        |  -spec start_link(atom(), climate_type(), pos_integer()) -&gt; {ok, pid()} | ignore | {error, {already_started, pid()} | any()}.
        |  start_link(City, Climate, UpdateInterval) -&gt;
     4..|    gen_server:start_link({local, ?MODULE}, ?MODULE, {City, Climate, UpdateInterval}, []).
        |  
        |  
        |  -spec init({atom(), climate_type(), pos_integer()}) -&gt; {ok, weather_controller_state()}.
        |  init({City, Climate, UpdateInterval}) -&gt;
     4..|    Pid = self(),
     4..|    Id = weather_controller,
     4..|    time:?SUBSCRIBE(?RECIPENT),
     4..|    Time = time:?GET_CURRENT_TIME(),
     4..|    ets:new(?MODULE, [named_table]),
     4..|    ets:insert(?MODULE, {type, sunny}),
     4..|    ets:insert(?MODULE, {temp, 20}),
     4..|    { ok, #weather_controller_state{ city=City
        |                                   , climate=Climate
        |                                   , downpourUpdates=0
        |                                   , lastChange=Time
        |                                   , updateInterval=UpdateInterval
        |                                   } }.
        |  
        |  
        |  -spec handle_call(any(), {pid(), any()}, weather_controller_state()) -&gt; {reply, ok, weather_controller_state()}.
        |  handle_call(_Msg, _From, State) -&gt;
<font color=red>     0..|    {reply, ok, State}.</font>
        |  
        |  
        |  -spec handle_cast({?NEW_TIME, time(), boolean(), pid()}, weather_controller_state()) -&gt; {noreply, weather_controller_state()}.
        |  handle_cast({?NEW_TIME, Time, NotifyCaller, Caller}, State) -&gt;
 35040..|    UpdateInterval = State#weather_controller_state.updateInterval,
 35040..|    UpdatedState = if
        |                     Time - State#weather_controller_state.lastChange &gt;= UpdateInterval -&gt;
 35040..|                       Climate = State#weather_controller_state.climate,
 35040..|                       Stats = case Climate of
  8760..|                                 coastal  -&gt; ?COASTAL_STATS;
  8760..|                                 inland   -&gt; ?INLAND_STATS;
  8760..|                                 northern -&gt; ?NORTHERN_STATS;
  8760..|                                 southern -&gt; ?SOUTHERN_STATS
        |                               end,
 35040..|                       {{Year, Month, _}, {Hour, _, _}} = calendar:gregorian_seconds_to_datetime(Time),
 35040..|                       MonthlyStats = lists:nth(Month, Stats),
 35040..|                       CurrentType = ?GET_TYPE(),
 35040..|                       DownpourUpdates = State#weather_controller_state.downpourUpdates,
 35040..|                       NewType = case CurrentType of
        |                                   sunny -&gt;
 30070..|                                     StartSnow = start_snow(Year, Month, UpdateInterval, MonthlyStats),
 30070..|                                     StartRain = start_rain(Year, Month, UpdateInterval, MonthlyStats),
 30070..|                                     if
   117..|                                       StartSnow -&gt; snowy;
   244..|                                       StartRain -&gt; rainy;
 29709..|                                       true      -&gt; sunny
        |                                     end;
        |                                   Downpour -&gt;
  4970..|                                     StopDownpour = stop_downpour(DownpourUpdates),
  4970..|                                     if
   361..|                                       StopDownpour -&gt; sunny;
  4609..|                                       true         -&gt; Downpour
        |                                     end
        |                                 end,
 35040..|                       NewDownpourUpdates = case CurrentType of
 30070..|                                              sunny -&gt; 0;
  4970..|                                              _     -&gt; DownpourUpdates + 1
        |                                            end,
 35040..|                       Temp = calculate_temp(Hour, MonthlyStats),
 35040..|                       ets:insert(?MODULE, {temp, Temp}),
 35040..|                       ets:insert(?MODULE, {type, NewType}),
 35040..|                       State#weather_controller_state{ lastChange=Time
        |                                                     , downpourUpdates=NewDownpourUpdates};
        |                     true -&gt;
<font color=red>     0..|                       State</font>
        |                   end,
 35040..|    gen_server_utils:notify_caller(NotifyCaller, Caller),
 35040..|    {noreply, UpdatedState}.
        |  
        |  
        |  -spec handle_info(timeout | any(), weather_controller_state()) -&gt; {noreply, weather_controller_state()}.
        |  handle_info(_Info, State) -&gt;
<font color=red>     0..|    {noreply, State}.</font>
        |  
        |  
        |  -spec terminate(normal | shutdown | {shutdown, any()} | any(), weather_controller_state()) -&gt; ok.
        |  terminate(_Reason, _State) -&gt;
<font color=red>     0..|    ok.</font>
        |  
        |  
        |  -spec code_change(term() | {down, term()}, weather_controller_state(), term()) -&gt; {ok, weather_controller_state()}.
        |  code_change(_OldVsn, State, _Extra) -&gt;
<font color=red>     0..|    {ok, State}.</font>
        |  
        |  %% Backend
        |  
        |  -spec start_snow(non_neg_integer(), 1..12, pos_integer(), monthly_stats()) -&gt; boolean().
        |  start_snow(Year, Month, UpdateInterval, MonthlyStats) -&gt;
 30070..|    start_downpour(Year, Month, UpdateInterval, MonthlyStats#monthly_stats.snowDays).
        |  
        |  
        |  -spec start_rain(non_neg_integer(), 1..12, pos_integer(), monthly_stats()) -&gt; boolean().
        |  start_rain(Year, Month, UpdateInterval, MonthlyStats) -&gt;
 30070..|    start_downpour(Year, Month, UpdateInterval, MonthlyStats#monthly_stats.rainDays).
        |  
        |  
        |  -spec start_downpour(non_neg_integer(), 1..12, pos_integer(), non_neg_integer()) -&gt; boolean().
        |  start_downpour(Year, Month, UpdateInterval, DownpourDays) -&gt;
 60140..|    Percentage = DownpourDays / calendar:last_day_of_the_month(Year, Month) / (86400/UpdateInterval) * 2 * 100,
 60140..|    X = rand_utils:uniform(0, 101),
 60140..|    X &lt; Percentage.
        |  
        |  
        |  -spec stop_downpour(pos_integer()) -&gt; boolean().
        |  stop_downpour(DownpourUpdates) -&gt;
  4970..|    X = rand_utils:uniform(0, 101),
  4970..|    X &lt; DownpourUpdates.
        |  
        |  -spec calculate_temp(0..23, monthly_stats()) -&gt; integer().
        |  calculate_temp(Hour, MonthlyStats) -&gt;
 35040..|    MaxTemp = MonthlyStats#monthly_stats.maxTemp,
 35040..|    MinTemp = MonthlyStats#monthly_stats.minTemp,
 35040..|    MedianTemp = MaxTemp - ((MaxTemp - MinTemp) div 2),
 35040..|    SunHours = MonthlyStats#monthly_stats.sunHours,
 35040..|    PreSunHours = (24-SunHours) div 2,
 35040..|    PostSunHours = 24 - PreSunHours - SunHours,
 35040..|    PreSunTemps = lists:map(fun(T) -&gt; rand_utils:uniform(T, MedianTemp) end, lists:duplicate(PreSunHours, MinTemp)),
 35040..|    SunTemps = lists:map(fun(T) -&gt; rand_utils:uniform(MedianTemp, T) end, lists:duplicate(SunHours, MaxTemp)),
 35040..|    PostSunTemps = lists:map(fun(T) -&gt; rand_utils:uniform(T, MedianTemp) end, lists:duplicate(PostSunHours, MinTemp)),
 35040..|    lists:nth(Hour + 1, PreSunTemps ++ SunTemps ++ PostSunTemps).
</pre>
</body>
</html>
