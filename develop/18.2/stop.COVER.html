<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/travis/build/SoamJaws/wErld/.eunit/stop.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/travis/build/SoamJaws/wErld/.eunit/stop.erl by COVER 2016-06-22 at 06:51:35

****************************************************************************

        |  -module(stop).
        |  -include("infrastructure.hrl").
        |  -behaviour(gen_server).
        |  
        |  %% Public API
        |  -export([ start_link/1
        |          , start_link/2
        |          , stop/1
        |          , state/1
        |          , ?PASSENGER_CHECK_IN/2
        |          , ?PASSENGER_CHECK_OUT/3
        |          , ?VEHICLE_CHECK_IN/3
        |          , ?VEHICLE_CHECK_OUT/3]).
        |  
        |  %% gen_server
        |  -export([ init/1
        |          , handle_call/3
        |          , handle_cast/2
        |          , handle_info/2
        |          , terminate/2
        |          , code_change/3]).
        |  
        |  
        |  %% Public API
        |  
        |  start_link(Id) -&gt;
    35..|    gen_server:start_link(?MODULE, #stop_state{id=Id}, []).
        |  
        |  start_link(Id, Capacity) -&gt;
     5..|    gen_server:start_link(?MODULE, #stop_state{id=Id, capacity=Capacity}, []).
        |  
        |  stop(Pid) -&gt;
    40..|    gen_server:call(Pid, stop).
        |  
        |  state(Pid) -&gt;
     1..|    gen_server:call(Pid, state).
        |  
        |  ?PASSENGER_CHECK_IN(Pid, Passenger) -&gt;
    17..|    gen_server:call(Pid, {?PASSENGER_CHECK_IN, Passenger}).
        |  
        |  ?PASSENGER_CHECK_OUT(Pid, Passenger, BlockCaller) -&gt;
     7..|    gen_server:cast(Pid, {?PASSENGER_CHECK_OUT, Passenger, BlockCaller, self()}),
     7..|    gen_server_utils:block_caller(BlockCaller).
        |  
        |  ?VEHICLE_CHECK_IN(Pid, Vehicle, BlockCaller) -&gt;
     6..|    gen_server:cast(Pid, {?VEHICLE_CHECK_IN, Vehicle, BlockCaller, self()}),
     6..|    gen_server_utils:block_caller(BlockCaller).
        |  
        |  ?VEHICLE_CHECK_OUT(Pid, Vehicle, BlockCaller) -&gt;
     2..|    gen_server:cast(Pid, {?VEHICLE_CHECK_OUT, Vehicle, BlockCaller, self()}),
     2..|    gen_server_utils:block_caller(BlockCaller).
        |  
        |  
        |  %% gen_server
        |  
        |  init(State) -&gt;
    40..|    {ok, State}.
        |  
        |  
        |  handle_call({?PASSENGER_CHECK_IN, Passenger}, _From, State) -&gt;
    17..|    Passengers = State#stop_state.passengers,
    17..|    Capacity = State#stop_state.capacity,
    17..|    NoPassengers = length(Passengers),
    17..|    AlreadyCheckedIn = lists:member(Passenger, Passengers),
    17..|    if
        |      AlreadyCheckedIn -&gt;
     1..|        {reply, {nok, "Already checked in"}, State};
        |      NoPassengers &lt; Capacity -&gt;
    15..|        {reply, ok, State#stop_state{passengers=Passengers++[Passenger]}};
        |      true -&gt;
     1..|        {reply, {nok, "Capacity reached"}, State}
        |    end;
        |  
        |  handle_call(stop, _From, State) -&gt;
    40..|    {stop, normal, stopped, State};
        |  
        |  handle_call(state, _From, State) -&gt;
     1..|    {reply, State, State}.
        |  
        |  
        |  handle_cast({?PASSENGER_CHECK_OUT, Passenger, NotifyCaller, Caller}, State) -&gt;
     7..|    Passengers = lists:delete(Passenger, State#stop_state.passengers),
     7..|    case Passengers of
        |      [] -&gt; %%TODO Maybe not all passengers are waiting for the currentVehicle 
     3..|        case State#stop_state.currentVehicle of 
        |          none -&gt;
     1..|            ok; %%Ok, passengers are permitted to leave the stop without boarding
        |          _ -&gt;
     2..|            vehicle:?BOARDING_COMPLETE(State#stop_state.currentVehicle, false)
        |        end;
        |      _ -&gt;
     4..|        ok
        |    end,
     7..|    gen_server_utils:notify_caller(NotifyCaller, Caller),
     7..|    {noreply, State#stop_state{passengers=Passengers}};
        |  
        |  handle_cast({?VEHICLE_CHECK_IN, Vehicle, NotifyCaller, Caller}, State) -&gt;
     6..|    NewState = case State#stop_state.currentVehicle of
        |                 none -&gt;
     4..|                   vehicle:?CHECKIN_OK(Vehicle, self(), false),
     4..|                   notify_vehicle_checked_in(State#stop_state.passengers, Vehicle),
     4..|                   State#stop_state{currentVehicle=Vehicle};
        |                 _    -&gt;
     2..|                   VehicleQueue = State#stop_state.vehicleQueue,
     2..|                   State#stop_state{vehicleQueue=VehicleQueue++[Vehicle]}
        |    end,
     6..|    gen_server_utils:notify_caller(NotifyCaller, Caller),
     6..|    {noreply, NewState};
        |  
        |  handle_cast({?VEHICLE_CHECK_OUT, Vehicle, NotifyCaller, Caller}, State) -&gt;
     2..|    NewState = if
        |                 State#stop_state.currentVehicle == Vehicle -&gt;
     2..|                   case State#stop_state.vehicleQueue of
        |                     [NextVehicle|VehicleQueue] -&gt;
     1..|                       vehicle:?CHECKIN_OK(NextVehicle, self(), false),
     1..|                       notify_vehicle_checked_in(State#stop_state.passengers, NextVehicle),
     1..|                       State#stop_state{currentVehicle=NextVehicle, vehicleQueue=VehicleQueue};
        |                     [] -&gt;
     1..|                       State#stop_state{currentVehicle=none}
        |                   end;
        |                 true -&gt;
<font color=red>     0..|                   State</font>
        |    end,
     2..|    gen_server_utils:notify_caller(NotifyCaller, Caller),
     2..|    {noreply, NewState}.
        |  
        |  
        |  handle_info(_Info, State) -&gt;
<font color=red>     0..|    {noreply, State}.</font>
        |  
        |  
        |  terminate(_Reason, _State) -&gt;
    40..|    ok.
        |  
        |  
        |  code_change(_OldVsn, State, _Extra) -&gt;
<font color=red>     0..|    {ok, State}.</font>
        |  
        |  
        |  %% Backend
        |  
     5..|  notify_vehicle_checked_in([], _Vehicle) -&gt; [];
        |  notify_vehicle_checked_in([Passenger|Passengers], Vehicle) -&gt;
    12..|    citizen:vehicle_checked_in(Passenger, Vehicle), %%Must block
    12..|    notify_vehicle_checked_in(Passengers, Vehicle).
</pre>
</body>
</html>
