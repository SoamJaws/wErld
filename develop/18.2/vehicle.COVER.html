<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/home/travis/build/SoamJaws/wErld/.eunit/vehicle.COVER.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /home/travis/build/SoamJaws/wErld/.eunit/vehicle.erl by COVER 2016-06-22 at 07:18:52

****************************************************************************

        |  -module(vehicle).
        |  -include("infrastructure.hrl").
        |  -behaviour(gen_server).
        |  
        |  %% Public API
        |  -export([ start_link/2
        |          , stop/1
        |          , state/1
        |          , ?PASSENGER_BOARD/2
        |          , ?BOARDING_COMPLETE/2
        |          , ?CHECKIN_OK/3]).
        |  
        |  %% gen_server
        |  -export([ init/1
        |          , handle_call/3
        |          , handle_cast/2
        |          , handle_info/2
        |          , terminate/2
        |          , code_change/3]).
        |  
        |  
        |  %% Public API
        |  
        |  start_link(Type, Capacity) -&gt;
<font color=red>     0..|    gen_server:start_link(?MODULE, #vehicle_state{type=Type, capacity=Capacity}, []).</font>
        |  
        |  stop(Pid) -&gt;
<font color=red>     0..|    gen_server:call(Pid, stop).</font>
        |  
        |  state(Pid) -&gt;
<font color=red>     0..|    gen_server:call(Pid, state).</font>
        |  
        |  ?PASSENGER_BOARD(Pid, Passenger) -&gt;
<font color=red>     0..|    gen_server:call(Pid, {?PASSENGER_BOARD, Passenger}).</font>
        |  
        |  ?BOARDING_COMPLETE(Pid, BlockCaller) -&gt;
     2..|    gen_server:cast(Pid, {?BOARDING_COMPLETE, BlockCaller, self()}),
     2..|    gen_server_utils:block_caller(BlockCaller).
        |  
        |  ?CHECKIN_OK(Pid, Stop, BlockCaller) -&gt;
     5..|    gen_server:cast(Pid, {?CHECKIN_OK, Stop, BlockCaller, self()}),
     5..|    gen_server_utils:block_caller(BlockCaller).
        |  
        |  
        |  %% gen_server
        |  
        |  init(State) -&gt;
<font color=red>     0..|    gen_server:call(blackboard, {subscribe, time}),</font>
<font color=red>     0..|    {ok, State}.</font>
        |  
        |  
        |  handle_call({?PASSENGER_BOARD, Passenger}, _From, State) -&gt;
<font color=red>     0..|    Passengers = State#vehicle_state.passengers,</font>
<font color=red>     0..|    Capacity = State#vehicle_state.capacity,</font>
<font color=red>     0..|    NoPassengers = length(Passengers),</font>
<font color=red>     0..|    if</font>
        |      NoPassengers &lt; Capacity -&gt;
<font color=red>     0..|        if Capacity - NoPassengers == 1 -&gt;</font>
<font color=red>     0..|          ?BOARDING_COMPLETE(self(), false)</font>
        |        end,
<font color=red>     0..|        {reply, ok, State#vehicle_state{passengers=Passengers++[Passenger]}};</font>
        |      true -&gt;
<font color=red>     0..|        {reply, nok, State}</font>
        |    end;
        |  
        |  handle_call(stop, _From, State) -&gt;
<font color=red>     0..|    {stop, normal, stopped, State};</font>
        |  
        |  handle_call(state, _From, State) -&gt;
<font color=red>     0..|    {reply, {ok, State}, State}.</font>
        |  
        |  
        |  handle_cast({?CHECKIN_OK, Stop, NotifyCaller, Caller}, State) -&gt;
<font color=red>     0..|    gen_server_utils:notify_caller(NotifyCaller, Caller),</font>
<font color=red>     0..|    {noreply, State#vehicle_state{action={boarding, Stop}}};</font>
        |  
        |  handle_cast({?BOARDING_COMPLETE, NotifyCaller, Caller}, State) -&gt;
<font color=red>     0..|    {_, Line} = State#vehicle_state.line,</font>
<font color=red>     0..|    {boarding, Stop} = State#vehicle_state.action,</font>
<font color=red>     0..|    {NextStop, Dur} = line:?GET_NEXT_STOP(Line, State#vehicle_state.target, Stop),</font>
<font color=red>     0..|    TimePid = gen_server:call(blackboard,{request, timePid}),</font>
<font color=red>     0..|    Time = gen_server:call(TimePid,{request,currentTime}),</font>
<font color=red>     0..|    stop:?VEHICLE_CHECK_OUT(Stop, self(), false),</font>
<font color=red>     0..|    gen_server_utils:notify_caller(NotifyCaller, Caller),</font>
<font color=red>     0..|    {noreply, State#vehicle_state{action={driving, NextStop, Dur}, lastDeparture=Time}};</font>
        |  
        |  handle_cast({time, Time}, State) -&gt;
<font color=red>     0..|    case State#vehicle_state.action of</font>
        |      {driving, Stop, Duration} -&gt;
<font color=red>     0..|        if</font>
        |          Time - State#vehicle_state.lastDeparture &gt;= Duration -&gt;
<font color=red>     0..|            UpdatedState = if</font>
        |                             Stop == State#vehicle_state.target -&gt;
<font color=red>     0..|                             Target = line:?GET_OTHER_END(State#vehicle_state.line, State#vehicle_state.target),</font>
<font color=red>     0..|                             State#vehicle_state{target=Target};</font>
        |                           true -&gt;
<font color=red>     0..|                             State</font>
        |                           end,
<font color=red>     0..|            StayingPassengers = notify_passengers_checkin(State#vehicle_state.passengers),</font>
<font color=red>     0..|            stop:?VEHICLE_CHECK_IN(Stop, self(), false),</font>
<font color=red>     0..|            {noreply, UpdatedState#vehicle_state{passengers=StayingPassengers}};</font>
        |          true -&gt;
<font color=red>     0..|            {noreply, State}</font>
        |        end;
        |      _ -&gt;
<font color=red>     0..|        {noreply, State}</font>
        |    end.
        |  
        |  
        |  handle_info(_Info, State) -&gt;
<font color=red>     0..|    {noreply, State}.</font>
        |  
        |  
        |  terminate(_Reason, _State) -&gt;
<font color=red>     0..|    ok.</font>
        |  
        |  
        |  code_change(_OldVsn, State, _Extra) -&gt;
<font color=red>     0..|    {ok, State}.</font>
        |  
        |  
        |  %% Backend
        |  
<font color=red>     0..|  notify_passengers_checkin([]) -&gt; [];</font>
        |  notify_passengers_checkin([Passenger|Passengers]) -&gt;
<font color=red>     0..|    Reply = citizen:vehicle_checked_in(Passenger, self()),</font>
<font color=red>     0..|    case Reply of</font>
        |      leave -&gt;
<font color=red>     0..|        notify_passengers_checkin(Passengers);</font>
        |      stay -&gt;
<font color=red>     0..|        [Passenger|notify_passengers_checkin(Passengers)]</font>
        |    end.
</pre>
</body>
</html>
